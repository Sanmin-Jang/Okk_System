<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ОКК в iframe</title>
<style>
  html, body { margin: 0; padding: 0; height: 100%; }
  iframe { width: 100%; height: 100vh; border: none; }
</style>
</head>
<body>

<iframe id="appFrame" src=""></iframe>

<script>
  const baseUrl = "https://script.google.com/macros/s/AKfycbzU-7LoOARRcgPdAFNeQP24bafaHIjmVLkJNOwdNt713_ALRTgSYJCPmPwXGdCl3qqT/exec";
  const iframe = document.getElementById('appFrame');

  const pages = [
    'Control', 'Analytics', 'Index', 'Scoring', 'Operators', 'Clinics',
    'KedmaAstana', 'FashionAstana', 'KedmaAlmaty',
    'ErrorKedmaAstana', 'ErrorKedmaAlmaty', 'ErrorFashionAstana', 'Main'
  ];

  // Начальная страница
  iframe.src = `${baseUrl}?page=Main`;

  // Текущая страница
  let currentPage = 'Main';

  // Функция для навигации
  function navigateToPage(page) {
    if (pages.includes(page)) {
      currentPage = page;
      iframe.src = `${baseUrl}?page=${encodeURIComponent(page)}`;
    }
  }

  // Перехват кликов в родительском окне
  document.addEventListener('click', function(e) {
    const target = e.target.closest('[data-page], a');
    if (!target) return;

    let page = target.getAttribute('data-page') || target.getAttribute('href');
    if (!page) return;

    // Извлекаем имя страницы из href или data-page
    const foundPage = pages.find(p => {
      if (page.startsWith('http')) {
        // Если это полный URL, ищем параметр page
        try {
          const url = new URL(page);
          const pageParam = url.searchParams.get('page');
          return pageParam === p;
        } catch (e) {
          return page.includes(p);
        }
      } else {
        // Если это просто имя страницы
        return page === p || page.includes(p);
      }
    });

    if (foundPage) {
      e.preventDefault();
      navigateToPage(foundPage);
    }
  });

  // Перехватываем навигацию iframe
  let lastSrc = iframe.src;
  
  const checkIframeNavigation = setInterval(() => {
    try {
      const currentSrc = iframe.src;
      
      // Если src изменился и это не наш собственный переход
      if (currentSrc !== lastSrc && !currentSrc.includes(`page=${currentPage}`)) {
        
        // Пытаемся извлечь page из нового URL
        const url = new URL(currentSrc);
        const newPage = url.searchParams.get('page');
        
        if (newPage && pages.includes(newPage)) {
          // Это валидная страница - разрешаем навигацию
          currentPage = newPage;
          lastSrc = currentSrc;
        } else {
          // Это невалидная навигация - возвращаем на предыдущую страницу
          iframe.src = lastSrc;
        }
      }
      
      lastSrc = iframe.src;
    } catch (e) {
      // Игнорируем ошибки
    }
  }, 100);

  // Обработка кнопок браузера (назад/вперед)
  window.addEventListener('popstate', function(event) {
    const urlParams = new URLSearchParams(window.location.search);
    const page = urlParams.get('page');
    if (page && pages.includes(page)) {
      navigateToPage(page);
    }
  });
</script>
</body>
</html>
