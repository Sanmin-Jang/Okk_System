<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ОКК Система</title>
<style>
  html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
  iframe { width: 100%; height: 100vh; border: none; display: block; }
</style>
</head>
<body>

<iframe id="appFrame" src=""></iframe>

<script>
  const baseUrl = "https://script.google.com/macros/s/AKfycby2F2eCJLVd7YwL1cjBd3yzYTRhymqCi264s1X5WlgQfkL-Lw7VweyTw2lhUzOIwzpi/exec";
  const iframe = document.getElementById('appFrame');

  const pages = [
    'Control', 'Analytics', 'Index', 'Scoring', 'Operators', 'Clinics',
    'KedmaAstana', 'FashionAstana', 'KedmaAlmaty',
    'ErrorKedmaAstana', 'ErrorKedmaAlmaty', 'ErrorFashionAstana', 'Main'
  ];

  // Текущая страница
  let currentPage = 'Main';

  // Блокируем window.open глобально
  const originalWindowOpen = window.open;
  window.open = function(url, target, features) {
    console.log('Блокирован window.open:', url);
    
    // Если это страница из нашего списка - обрабатываем в iframe
    if (url && typeof url === 'string') {
      const foundPage = extractPageFromUrl(url);
      if (foundPage && pages.includes(foundPage)) {
        navigateToPage(foundPage);
        return null; // Блокируем реальное открытие
      }
    }
    
    // Для других URL можно показать предупреждение или ничего не делать
    return null; // Полностью блокируем
  };

  // Функция извлечения страницы из URL
  function extractPageFromUrl(url) {
    try {
      const urlObj = new URL(url);
      return urlObj.searchParams.get('page');
    } catch (e) {
      // Если это не полный URL, ищем прямое совпадение
      return pages.find(page => url.includes(page));
    }
  }

  // Навигация
  function navigateToPage(page) {
    if (pages.includes(page)) {
      currentPage = page;
      iframe.src = `${baseUrl}?page=${encodeURIComponent(page)}`;
      
      // Обновляем URL в адресной строке
      const newUrl = `${window.location.pathname}?page=${page}`;
      window.history.pushState({}, '', newUrl);
    }
  }

  // Агрессивный перехват навигации iframe
  let isProgrammaticNavigation = false;

  // Перехватываем изменения src iframe
  const iframeSrcDescriptor = Object.getOwnPropertyDescriptor(HTMLIFrameElement.prototype, 'src');
  Object.defineProperty(iframe, 'src', {
    get: function() {
      return iframeSrcDescriptor.get.call(this);
    },
    set: function(value) {
      if (isProgrammaticNavigation) {
        // Разрешаем наши изменения
        iframeSrcDescriptor.set.call(this, value);
      } else {
        // Перехватываем внешние изменения
        const foundPage = extractPageFromUrl(value);
        if (foundPage && pages.includes(foundPage)) {
          isProgrammaticNavigation = true;
          navigateToPage(foundPage);
          isProgrammaticNavigation = false;
        }
        // Игнорируем другие URL
      }
    }
  });

  // Перехватываем загрузку iframe для блокировки _top навигации
  iframe.addEventListener('load', function() {
    try {
      // Пытаемся переопределить window.top для iframe
      iframe.contentWindow.top = window;
    } catch (e) {
      // Игнорируем CORS ошибки
    }
  });

  // Мониторим изменения location iframe
  let lastIframeUrl = '';
  const navigationMonitor = setInterval(() => {
    try {
      const currentUrl = iframe.src;
      if (currentUrl !== lastIframeUrl && !isProgrammaticNavigation) {
        const foundPage = extractPageFromUrl(currentUrl);
        
        if (foundPage && pages.includes(foundPage)) {
          // Это наша страница - обновляем состояние
          currentPage = foundPage;
          lastIframeUrl = currentUrl;
        } else if (foundPage) {
          // Чужой URL - возвращаем назад
          iframe.src = lastIframeUrl;
        }
        
        lastIframeUrl = iframe.src;
      }
    } catch (e) {
      // Игнорируем CORS ошибки
    }
  }, 100);

  // Блокируем beforeunload если iframe пытается закрыть окно
  window.addEventListener('beforeunload', function(e) {
    // Если это не наша инициатива - блокируем
    if (!isProgrammaticNavigation) {
      e.preventDefault();
      e.returnValue = '';
      return '';
    }
  });

  // Инициализация
  navigateToPage('Main');

  // Очистка при разгрузке страницы
  window.addEventListener('unload', function() {
    clearInterval(navigationMonitor);
  });
</script>
</body>
</html>
